{% extends "base.html" %}

{% block head %}
<script src="https://www.google.com/recaptcha/api.js?render={{ config.RECAPTCHA_SITE_KEY or '' }}" async defer></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Customer Lookup</h2>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" class="form-control" id="searchInput" placeholder="Search customers by name, phone, or license number...">
    </div>
    <div class="col-md-6">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">Add New Customer</button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadCustomersModal">Upload Customers CSV</button>
        <button class="btn btn-warning" onclick="validateAllAddresses()"><i class="fas fa-map-marker-alt"></i> Validate All Addresses</button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Customers</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="customerTable">
                        <thead>
                            <tr>
                                <th data-sort="name" onclick="sortTable('name')" style="cursor: pointer;">Name ↕</th>
                                <th data-sort="phone" onclick="sortTable('phone')" style="cursor: pointer;">Phone ↕</th>
                                <th data-sort="drivers_license_number" onclick="sortTable('drivers_license_number')" style="cursor: pointer;">License # ↕</th>
                                <th data-sort="address" onclick="sortTable('address')" style="cursor: pointer;">City, State ↕</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <!-- Customers loaded via JavaScript -->
                        </tbody>
                    </table>
                    <nav id="paginationNav" class="mt-3">
                        <ul class="pagination justify-content-center" id="paginationList">
                            <!-- Pagination loaded via JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Full Name *</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" name="phone">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Driver's License Number</label>
                                <input type="text" class="form-control" name="drivers_license_number">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Birthday</label>
                                <input type="date" class="form-control" name="birthday">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Gender</label>
                                        <select class="form-control" name="gender">
                                            <option value="">Select Gender</option>
                                            <option value="M">Male</option>
                                            <option value="F">Female</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Eye Color</label>
                                        <select class="form-control" name="eye_color">
                                            <option value="">Select Eye Color</option>
                                            <option value="BLU">Blue</option>
                                            <option value="BRO">Brown</option>
                                            <option value="GRN">Green</option>
                                            <option value="HAZ">Hazel</option>
                                            <option value="GRY">Gray</option>
                                            <option value="BLK">Black</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Street Address</label>
                                <input type="text" class="form-control" name="street_address" id="streetAddress">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" name="city" id="city">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">State</label>
                                        <select class="form-control" name="state" id="state">
                                            <option value="">Select State</option>
                                            <option value="AL">AL - Alabama</option>
                                            <option value="AK">AK - Alaska</option>
                                            <option value="AZ">AZ - Arizona</option>
                                            <option value="AR">AR - Arkansas</option>
                                            <option value="CA">CA - California</option>
                                            <option value="CO">CO - Colorado</option>
                                            <option value="CT">CT - Connecticut</option>
                                            <option value="DE">DE - Delaware</option>
                                            <option value="FL">FL - Florida</option>
                                            <option value="GA">GA - Georgia</option>
                                            <option value="HI">HI - Hawaii</option>
                                            <option value="ID">ID - Idaho</option>
                                            <option value="IL">IL - Illinois</option>
                                            <option value="IN">IN - Indiana</option>
                                            <option value="IA">IA - Iowa</option>
                                            <option value="KS">KS - Kansas</option>
                                            <option value="KY">KY - Kentucky</option>
                                            <option value="LA">LA - Louisiana</option>
                                            <option value="ME">ME - Maine</option>
                                            <option value="MD">MD - Maryland</option>
                                            <option value="MA">MA - Massachusetts</option>
                                            <option value="MI">MI - Michigan</option>
                                            <option value="MN">MN - Minnesota</option>
                                            <option value="MS">MS - Mississippi</option>
                                            <option value="MO">MO - Missouri</option>
                                            <option value="MT">MT - Montana</option>
                                            <option value="NE">NE - Nebraska</option>
                                            <option value="NV">NV - Nevada</option>
                                            <option value="NH">NH - New Hampshire</option>
                                            <option value="NJ">NJ - New Jersey</option>
                                            <option value="NM">NM - New Mexico</option>
                                            <option value="NY">NY - New York</option>
                                            <option value="NC">NC - North Carolina</option>
                                            <option value="ND">ND - North Dakota</option>
                                            <option value="OH">OH - Ohio</option>
                                            <option value="OK">OK - Oklahoma</option>
                                            <option value="OR">OR - Oregon</option>
                                            <option value="PA">PA - Pennsylvania</option>
                                            <option value="RI">RI - Rhode Island</option>
                                            <option value="SC">SC - South Carolina</option>
                                            <option value="SD">SD - South Dakota</option>
                                            <option value="TN">TN - Tennessee</option>
                                            <option value="TX">TX - Texas</option>
                                            <option value="UT">UT - Utah</option>
                                            <option value="VT">VT - Vermont</option>
                                            <option value="VA">VA - Virginia</option>
                                            <option value="WA">WA - Washington</option>
                                            <option value="WV">WV - West Virginia</option>
                                            <option value="WI">WI - Wisconsin</option>
                                            <option value="WY">WY - Wyoming</option>
                                            <option value="DC">DC - District of Columbia</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">ZIP Code</label>
                                        <input type="text" class="form-control" name="zip_code" id="zipCode" pattern="[0-9]{5}(-[0-9]{4})?" placeholder="12345">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="validateAddress()">Validate Address</button>
                                <div id="addressValidation" class="mt-2"></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Driver's License Photo</label>
                                <input type="file" class="form-control" name="license_photo" accept="image/*" onchange="previewLicensePhoto(this)">
                                <div class="form-text">Upload photo of driver's license</div>
                                <div id="uploadStatus" class="mt-2" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted">Uploading...</small>
                                </div>
                                <div id="licensePreview" class="mt-2" style="display: none;">
                                    <img id="licensePreviewImg" src="" style="max-width: 200px; max-height: 150px; border: 1px solid #ccc;">
                                    <div><small class="text-muted">Preview of uploaded license</small></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-success" onclick="scanLicense()">Scan Driver's License</button>
                                <button type="button" class="btn btn-info" onclick="capturePhoto()">Capture with Camera</button>
                                <button type="button" class="btn btn-warning" onclick="extractLicenseData()">Extract Data from Photo</button>
                            </div>
                            <div id="scannerStatus" class="mb-3" style="display: none;">
                                <div class="alert alert-info">
                                    <div id="scannerMessage">Initializing scanner...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Customers CSV Modal -->
<div class="modal fade" id="uploadCustomersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Customers CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6>CSV Format Requirements:</h6>
                    <p><strong>Expected headers:</strong> Last Name, Middle Name, First Name, Drivers License, Street Address, City, State, Zip code, Birthday, Gender, Eye Color, Phone Number</p>
                    <p><strong>Data will be automatically processed:</strong></p>
                    <ul class="mb-0">
                        <li>Names will be combined into single field</li>
                        <li>Dates converted from M/D/YYYY format</li>
                        <li>Gender standardized (MALE/FEMALE → M/F)</li>
                        <li>Fields truncated to fit database limits</li>
                        <li>Duplicates skipped based on license number or name</li>
                    </ul>
                </div>
                <div class="alert alert-warning">
                    <h6>Data Validation Notes:</h6>
                    <ul class="mb-0">
                        <li>Street addresses limited to 200 characters</li>
                        <li>Driver's license numbers limited to 50 characters</li>
                        <li>Phone numbers limited to 20 characters</li>
                        <li>City names limited to 100 characters</li>
                        <li>Eye color codes will be preserved as-is</li>
                    </ul>
                </div>
                <form id="uploadCustomersForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">CSV File</label>
                        <input type="file" class="form-control" name="csv_file" accept=".csv" required>
                    </div>
                    <div id="uploadProgress" class="mt-3"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="uploadCustomersCSV()">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm" enctype="multipart/form-data">
                    <input type="hidden" id="editCustomerId" name="customer_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Full Name *</label>
                                <input type="text" class="form-control" name="name" id="editName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" name="phone" id="editPhone">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" id="editEmail">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Driver's License Number</label>
                                <input type="text" class="form-control" name="drivers_license_number" id="editLicense">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Birthday</label>
                                <input type="date" class="form-control" name="birthday" id="editBirthday">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Gender</label>
                                        <select class="form-control" name="gender" id="editGender">
                                            <option value="">Select Gender</option>
                                            <option value="M">Male</option>
                                            <option value="F">Female</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Eye Color</label>
                                        <select class="form-control" name="eye_color" id="editEyeColor">
                                            <option value="">Select Eye Color</option>
                                            <option value="BLU">Blue</option>
                                            <option value="BRO">Brown</option>
                                            <option value="GRN">Green</option>
                                            <option value="HAZ">Hazel</option>
                                            <option value="GRY">Gray</option>
                                            <option value="BLK">Black</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Street Address</label>
                                <input type="text" class="form-control" name="street_address" id="editStreet">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" name="city" id="editCity">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">State</label>
                                        <select class="form-control" name="state" id="editState">
                                            <option value="">Select State</option>
                                            <option value="AL">AL - Alabama</option>
                                            <option value="AK">AK - Alaska</option>
                                            <option value="AZ">AZ - Arizona</option>
                                            <option value="AR">AR - Arkansas</option>
                                            <option value="CA">CA - California</option>
                                            <option value="CO">CO - Colorado</option>
                                            <option value="CT">CT - Connecticut</option>
                                            <option value="DE">DE - Delaware</option>
                                            <option value="FL">FL - Florida</option>
                                            <option value="GA">GA - Georgia</option>
                                            <option value="HI">HI - Hawaii</option>
                                            <option value="ID">ID - Idaho</option>
                                            <option value="IL">IL - Illinois</option>
                                            <option value="IN">IN - Indiana</option>
                                            <option value="IA">IA - Iowa</option>
                                            <option value="KS">KS - Kansas</option>
                                            <option value="KY">KY - Kentucky</option>
                                            <option value="LA">LA - Louisiana</option>
                                            <option value="ME">ME - Maine</option>
                                            <option value="MD">MD - Maryland</option>
                                            <option value="MA">MA - Massachusetts</option>
                                            <option value="MI">MI - Michigan</option>
                                            <option value="MN">MN - Minnesota</option>
                                            <option value="MS">MS - Mississippi</option>
                                            <option value="MO">MO - Missouri</option>
                                            <option value="MT">MT - Montana</option>
                                            <option value="NE">NE - Nebraska</option>
                                            <option value="NV">NV - Nevada</option>
                                            <option value="NH">NH - New Hampshire</option>
                                            <option value="NJ">NJ - New Jersey</option>
                                            <option value="NM">NM - New Mexico</option>
                                            <option value="NY">NY - New York</option>
                                            <option value="NC">NC - North Carolina</option>
                                            <option value="ND">ND - North Dakota</option>
                                            <option value="OH">OH - Ohio</option>
                                            <option value="OK">OK - Oklahoma</option>
                                            <option value="OR">OR - Oregon</option>
                                            <option value="PA">PA - Pennsylvania</option>
                                            <option value="RI">RI - Rhode Island</option>
                                            <option value="SC">SC - South Carolina</option>
                                            <option value="SD">SD - South Dakota</option>
                                            <option value="TN">TN - Tennessee</option>
                                            <option value="TX">TX - Texas</option>
                                            <option value="UT">UT - Utah</option>
                                            <option value="VT">VT - Vermont</option>
                                            <option value="VA">VA - Virginia</option>
                                            <option value="WA">WA - Washington</option>
                                            <option value="WV">WV - West Virginia</option>
                                            <option value="WI">WI - Wisconsin</option>
                                            <option value="WY">WY - Wyoming</option>
                                            <option value="DC">DC - District of Columbia</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">ZIP Code</label>
                                        <input type="text" class="form-control" name="zip_code" id="editZip" pattern="[0-9]{5}(-[0-9]{4})?" placeholder="12345">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="validateEditAddress()">Validate Address</button>
                                <div id="editAddressValidation" class="mt-2"></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Driver's License Photo</label>
                                <div id="existingLicense" class="mb-2" style="display: none;">
                                    <img id="existingLicenseImg" src="" style="max-width: 200px; max-height: 150px; border: 1px solid #ccc;">
                                    <div><small class="text-muted">Current license photo</small></div>
                                </div>
                                <input type="file" class="form-control" name="license_photo" accept="image/*" onchange="previewEditLicensePhoto(this)">
                                <div class="form-text">Upload new photo (optional)</div>
                                <div id="editUploadStatus" class="mt-2" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted">Uploading...</small>
                                </div>
                                <div id="editLicensePreview" class="mt-2" style="display: none;">
                                    <img id="editLicensePreviewImg" src="" style="max-width: 200px; max-height: 150px; border: 1px solid #ccc;">
                                    <div><small class="text-muted">Preview of new license</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateCustomer()">Update Customer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.sorted-asc::after { content: ' ↑'; }
.sorted-desc::after { content: ' ↓'; }
th[data-sort]:hover { background-color: #f8f9fa; }
</style>
{% endblock %}

{% block scripts %}
<script>
function saveCustomer() {
    const form = document.getElementById('customerForm');
    const formData = new FormData(form);
    const uploadStatus = document.getElementById('uploadStatus');
    const progressBar = uploadStatus.querySelector('.progress-bar');
    const statusText = uploadStatus.querySelector('small');
    
    // Show upload status if there's a file
    const fileInput = form.querySelector('input[name="license_photo"]');
    if (fileInput.files.length > 0) {
        uploadStatus.style.display = 'block';
        statusText.textContent = 'Uploading customer data...';
        progressBar.style.width = '50%';
    }
    
    fetch('/api/customers/create', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (fileInput.files.length > 0) {
            progressBar.style.width = '100%';
            statusText.textContent = 'Upload complete!';
        }
        return response.json();
    })
    .then(data => {
        uploadStatus.style.display = 'none';
        progressBar.style.width = '0%';
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
            form.reset();
            document.getElementById('licensePreview').style.display = 'none';
            loadCustomerList(currentPage);
        } else {
            alert('Error adding customer: ' + data.error);
        }
    })
    .catch(error => {
        uploadStatus.style.display = 'none';
        progressBar.style.width = '0%';
        alert('Error saving customer: ' + error.message);
    });
}

let currentPage = 1;
let currentSearch = '';

function loadCustomerList(page = 1, search = null) {
    if (search !== null) currentSearch = search;
    currentPage = page;
    
    let url = `/api/customers/list?page=${page}`;
    if (currentSearch) {
        url += `&search=${encodeURIComponent(currentSearch)}`;
    }
    
    fetch(url)
    .then(response => response.json())
    .then(data => {
        updateCustomerTable(data.customers || []);
        updatePagination(data.pagination);
    })
    .catch(error => {
        console.error('Error loading customers:', error);
    });
}

function updatePagination(pagination) {
    if (!pagination) return;
    
    totalPages = pagination.pages;
    const paginationList = document.getElementById('paginationList');
    paginationList.innerHTML = '';
    
    // Previous button
    if (pagination.has_prev) {
        paginationList.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadCustomerList(${pagination.page - 1}, '${currentSearch}')">Previous</a></li>`;
    }
    
    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === pagination.page ? 'active' : '';
        paginationList.innerHTML += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadCustomerList(${i}, '${currentSearch}')">${i}</a></li>`;
    }
    
    // Next button
    if (pagination.has_next) {
        paginationList.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadCustomerList(${pagination.page + 1}, '${currentSearch}')">Next</a></li>`;
    }
    
    // Show pagination info
    const nav = document.getElementById('paginationNav');
    const existingInfo = nav.querySelector('.pagination-info');
    if (existingInfo) existingInfo.remove();
    
    const start = (pagination.page - 1) * pagination.per_page + 1;
    const end = Math.min(pagination.page * pagination.per_page, pagination.total);
    nav.innerHTML += `<div class="text-center mt-2 pagination-info"><small>Showing ${start}-${end} of ${pagination.total} customers</small></div>`;
}

function updateCustomerTable(customers) {
    const tbody = document.getElementById('customerTableBody');
    tbody.innerHTML = '';
    
    if (!customers.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No customers found</td></tr>';
        return;
    }
    
    customers.forEach(customer => {
        const cityState = customer.city && customer.state ? `${customer.city}, ${customer.state}` : 'No address';
        const row = `
            <tr>
                <td>${customer.name}</td>
                <td>${customer.phone || 'N/A'}</td>
                <td>${customer.drivers_license_number || 'N/A'}</td>
                <td>${cityState}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editCustomer(${customer.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})">Delete</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function sortTable(column) {
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'asc';
    }
    
    const sorted = [...currentCustomers].sort((a, b) => {
        let aVal = a[column] || '';
        let bVal = b[column] || '';
        
        if (column === 'address') {
            aVal = parseAddressForDisplay(a.address);
            bVal = parseAddressForDisplay(b.address);
        }
        
        const result = aVal.localeCompare(bVal);
        return sortDirection === 'asc' ? result : -result;
    });
    
    updateCustomerTable(sorted);
    updateSortHeaders();
}

function updateSortHeaders() {
    document.querySelectorAll('th[data-sort]').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === sortColumn) {
            th.classList.add(`sorted-${sortDirection}`);
        }
    });
}

function editCustomer(customerId) {
    fetch(`/api/customers/${customerId}`)
    .then(response => response.json())
    .then(data => {
        const customer = data.customer;
        document.getElementById('editCustomerId').value = customer.id;
        document.getElementById('editName').value = customer.name;
        document.getElementById('editPhone').value = customer.phone || '';
        document.getElementById('editEmail').value = customer.email || '';
        document.getElementById('editLicense').value = customer.drivers_license_number || '';
        document.getElementById('editBirthday').value = customer.birthday || '';
        document.getElementById('editGender').value = customer.gender || '';
        document.getElementById('editEyeColor').value = customer.eye_color || '';
        document.getElementById('editStreet').value = customer.street_address || '';
        document.getElementById('editCity').value = customer.city || '';
        document.getElementById('editState').value = customer.state || '';
        document.getElementById('editZip').value = customer.zip_code || '';
        
        // Show existing license photo if available
        const existingLicense = document.getElementById('existingLicense');
        const existingLicenseImg = document.getElementById('existingLicenseImg');
        if (customer.drivers_license_photo_path) {
            existingLicenseImg.src = `/photo/customer/${customer.id}/license`;
            existingLicense.style.display = 'block';
        } else {
            existingLicense.style.display = 'none';
        }
        
        new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
    });
}

function updateCustomer() {
    const form = document.getElementById('editCustomerForm');
    const formData = new FormData(form);
    const customerId = document.getElementById('editCustomerId').value;
    const uploadStatus = document.getElementById('editUploadStatus');
    const progressBar = uploadStatus.querySelector('.progress-bar');
    const statusText = uploadStatus.querySelector('small');
    
    // Show upload status if there's a file
    const fileInput = form.querySelector('input[name="license_photo"]');
    if (fileInput.files.length > 0) {
        uploadStatus.style.display = 'block';
        statusText.textContent = 'Uploading updated data...';
        progressBar.style.width = '50%';
    }
    
    fetch(`/api/customers/update/${customerId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (fileInput.files.length > 0) {
            progressBar.style.width = '100%';
            statusText.textContent = 'Upload complete!';
        }
        return response.json();
    })
    .then(data => {
        uploadStatus.style.display = 'none';
        progressBar.style.width = '0%';
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
            loadCustomerList(currentPage);
        } else {
            alert('Error updating customer: ' + data.error);
        }
    })
    .catch(error => {
        uploadStatus.style.display = 'none';
        progressBar.style.width = '0%';
        alert('Error updating customer: ' + error.message);
    });
}

function deleteCustomer(customerId) {
    if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/customers/delete/${customerId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadCustomerList(currentPage);
        } else {
            alert('Error deleting customer: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error deleting customer: ' + error.message);
    });
}





function capturePhoto() {
    // Use camera service to capture license photo
    fetch('/api/camera/capture', {method: 'POST'})
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Photo captured successfully');
            // Set the captured photo as the license photo
        } else {
            alert('Error capturing photo');
        }
    });
}

function uploadCustomersCSV() {
    const form = document.getElementById('uploadCustomersForm');
    const formData = new FormData(form);
    const progress = document.getElementById('uploadProgress');
    
    const fileInput = form.querySelector('input[type="file"]');
    if (!fileInput.files.length) {
        progress.innerHTML = '<div class="alert alert-danger">Please select a CSV file to upload.</div>';
        return;
    }
    
    progress.innerHTML = `
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <div>Processing CSV file: ${fileInput.files[0].name}...</div>
            </div>
            <small>Validating data format and importing customers...</small>
        </div>
    `;
    
    fetch('/api/customers/upload_csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progress.innerHTML = `
                <div class="alert alert-success">
                    <h6>Upload Complete!</h6>
                    <ul class="mb-0">
                        <li><strong>${data.imported}</strong> customers successfully imported</li>
                        <li><strong>${data.skipped}</strong> duplicates skipped</li>
                    </ul>
                    <small class="text-muted">Customer list will refresh automatically...</small>
                </div>
            `;
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('uploadCustomersModal')).hide();
                form.reset();
                loadCustomerList(currentPage);
            }, 3000);
        } else {
            progress.innerHTML = `
                <div class="alert alert-danger">
                    <h6>Upload Failed</h6>
                    <p>${data.error}</p>
                    <small>Please check your CSV format and try again.</small>
                </div>
            `;
        }
    })
    .catch(error => {
        progress.innerHTML = `
            <div class="alert alert-danger">
                <h6>Upload Error</h6>
                <p>Network error or server unavailable. Please try again.</p>
            </div>
        `;
    });
}

async function scanLicense() {
    const statusDiv = document.getElementById('scannerStatus');
    const messageDiv = document.getElementById('scannerMessage');
    
    try {
        statusDiv.style.display = 'block';
        messageDiv.textContent = 'Connecting to license scanner...';
        
        // Connect to scanner
        const connectResult = await window.licenseScanner.connect();
        if (!connectResult.success) {
            throw new Error(connectResult.error);
        }
        
        messageDiv.textContent = 'Scanner connected. Please insert driver\'s license...';
        
        // Scan license
        const scanResult = await window.licenseScanner.scanLicense();
        
        if (scanResult.success) {
            // Fill form with scanned data
            const data = scanResult.data;
            if (data.name) document.querySelector('[name="name"]').value = data.name;
            if (data.drivers_license_number) document.querySelector('[name="drivers_license_number"]').value = data.drivers_license_number;
            if (data.date_of_birth) document.querySelector('[name="birthday"]').value = data.date_of_birth;
            if (data.address) document.querySelector('[name="street_address"]').value = data.address;
            
            messageDiv.textContent = 'License scanned successfully!';
            statusDiv.className = 'mb-3';
            statusDiv.querySelector('.alert').className = 'alert alert-success';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        } else {
            throw new Error('Scan failed');
        }
        
    } catch (error) {
        messageDiv.textContent = `Scanner error: ${error.message}`;
        statusDiv.className = 'mb-3';
        statusDiv.querySelector('.alert').className = 'alert alert-danger';
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    } finally {
        // Disconnect scanner
        try {
            await window.licenseScanner.disconnect();
        } catch (e) {
            console.error('Error disconnecting scanner:', e);
        }
    }
}

function extractLicenseData() {
    const fileInput = document.querySelector('[name="license_photo"]');
    if (!fileInput.files.length) {
        alert('Please select a license photo first');
        return;
    }
    
    // Show extraction status
    const statusDiv = document.createElement('div');
    statusDiv.className = 'alert alert-info mt-2';
    statusDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <div>Extracting data from license photo...</div>
        </div>
    `;
    
    const extractBtn = event.target;
    extractBtn.parentNode.appendChild(statusDiv);
    extractBtn.disabled = true;
    
    const formData = new FormData();
    formData.append('license_photo', fileInput.files[0]);
    
    fetch('/api/ocr/extract_license', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        statusDiv.remove();
        extractBtn.disabled = false;
        
        if (data.success) {
            // Fill form fields with extracted data
            const extracted = data.data;
            if (extracted.name) {
                document.querySelector('[name="name"]').value = extracted.name;
            }
            if (extracted.license_number) {
                document.querySelector('[name="drivers_license_number"]').value = extracted.license_number;
            }
            if (extracted.date_of_birth) {
                document.querySelector('[name="birthday"]').value = extracted.date_of_birth;
            }
            if (extracted.gender) {
                document.querySelector('[name="gender"]').value = extracted.gender;
            }
            if (extracted.eye_color) {
                document.querySelector('[name="eye_color"]').value = extracted.eye_color;
            }
            if (extracted.address) {
                document.querySelector('[name="street_address"]').value = extracted.address;
            }
            
            // Show success status
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success mt-2';
            successDiv.innerHTML = '✓ Data extracted successfully!';
            extractBtn.parentNode.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        } else {
            // Show error status
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mt-2';
            errorDiv.innerHTML = '✗ OCR extraction failed: ' + data.error;
            extractBtn.parentNode.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }
    })
    .catch(error => {
        statusDiv.remove();
        extractBtn.disabled = false;
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-2';
        errorDiv.innerHTML = '✗ Error extracting data: ' + error.message;
        extractBtn.parentNode.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    });
}

// Search with debounce for server-side filtering
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function() {
    const query = this.value.trim();
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        loadCustomerList(1, query);
    }, 300);
});

function validateAddress() {
    const street = document.getElementById('streetAddress').value;
    const city = document.getElementById('city').value;
    const state = document.getElementById('state').value;
    const zip = document.getElementById('zipCode').value;
    
    const validation = document.getElementById('addressValidation');
    
    if (!street || !city || !state) {
        validation.innerHTML = '<small class="text-warning">Please fill street, city, and state fields</small>';
        return false;
    }
    
    validation.innerHTML = '<small class="text-info">Validating address...</small>';
    
    performAddressValidation(street, city, state, zip, validation);
}

function performAddressValidation(street, city, state, zip, validation, recaptchaToken = null) {
    const payload = {street, city, state, zipcode: zip};
    if (recaptchaToken) {
        payload.recaptcha_token = recaptchaToken;
    }
    
    fetch('/api/address/validate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const addr = data.data;
            document.getElementById('streetAddress').value = addr.street;
            document.getElementById('city').value = addr.city;
            document.getElementById('state').value = addr.state;
            document.getElementById('zipCode').value = addr.zipcode;
            validation.innerHTML = '<small class="text-success">✓ Address validated</small>';
        } else if (data.data && data.data.requires_recaptcha) {
            // Execute reCAPTCHA and retry
            if (typeof grecaptcha !== 'undefined') {
                grecaptcha.ready(() => {
                    grecaptcha.execute('{{ config.RECAPTCHA_SITE_KEY or "" }}', {action: 'validate_address'})
                    .then(token => {
                        performAddressValidation(street, city, state, zip, validation, token);
                    });
                });
            } else {
                validation.innerHTML = '<small class="text-danger">⚠ reCAPTCHA required but not loaded</small>';
            }
        } else {
            validation.innerHTML = '<small class="text-danger">⚠ ' + (data.data ? data.data.error : 'Validation failed') + '</small>';
        }
    })
    .catch(error => {
        validation.innerHTML = '<small class="text-danger">Validation failed. Please check your connection.</small>';
    });
}

function validateEditAddress() {
    const street = document.getElementById('editStreet').value;
    const city = document.getElementById('editCity').value;
    const state = document.getElementById('editState').value;
    const zip = document.getElementById('editZip').value;
    
    const validation = document.getElementById('editAddressValidation');
    
    if (!street || !city || !state) {
        validation.innerHTML = '<small class="text-warning">Please fill street, city, and state fields</small>';
        return false;
    }
    
    validation.innerHTML = '<small class="text-info">Validating address...</small>';
    
    performEditAddressValidation(street, city, state, zip, validation);
}

function performEditAddressValidation(street, city, state, zip, validation, recaptchaToken = null) {
    const payload = {street, city, state, zipcode: zip};
    if (recaptchaToken) {
        payload.recaptcha_token = recaptchaToken;
    }
    
    fetch('/api/address/validate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const addr = data.data;
            document.getElementById('editStreet').value = addr.street;
            document.getElementById('editCity').value = addr.city;
            document.getElementById('editState').value = addr.state;
            document.getElementById('editZip').value = addr.zipcode;
            validation.innerHTML = '<small class="text-success">✓ Address validated</small>';
        } else if (data.data && data.data.requires_recaptcha) {
            if (typeof grecaptcha !== 'undefined') {
                grecaptcha.ready(() => {
                    grecaptcha.execute('{{ config.RECAPTCHA_SITE_KEY or "" }}', {action: 'validate_address'})
                    .then(token => {
                        performEditAddressValidation(street, city, state, zip, validation, token);
                    });
                });
            } else {
                validation.innerHTML = '<small class="text-danger">⚠ reCAPTCHA required but not loaded</small>';
            }
        } else {
            validation.innerHTML = '<small class="text-danger">⚠ ' + (data.data ? data.data.error : 'Validation failed') + '</small>';
        }
    })
    .catch(error => {
        validation.innerHTML = '<small class="text-danger">Validation failed. Please check your connection.</small>';
    });
}

function parseAddressForDisplay(address) {
    if (!address) return 'No address';
    const parts = address.split(' ');
    if (parts.length >= 2) {
        // Try to find state and return city, state
        const state = parts.find(part => /^[A-Z]{2}$/.test(part));
        if (state) {
            const stateIndex = parts.indexOf(state);
            const city = parts.slice(Math.max(0, stateIndex - 2), stateIndex).join(' ');
            return `${city}, ${state}`;
        }
    }
    return address.substring(0, 30) + (address.length > 30 ? '...' : '');
}

function validateAllAddresses() {
    if (!confirm('This will validate all customer addresses in the database. This may take several minutes. Continue?')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    
    // Create status display
    let statusDiv = document.getElementById('validationStatus');
    if (!statusDiv) {
        statusDiv = document.createElement('div');
        statusDiv.id = 'validationStatus';
        statusDiv.className = 'alert alert-info mt-2';
        btn.parentNode.appendChild(statusDiv);
    }
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting validation...';
    statusDiv.innerHTML = 'Preparing to validate addresses...';
    
    let validated = 0;
    let errors = 0;
    let total = 0;
    
    // Get customer count first
    fetch('/api/customers/count_addresses')
    .then(response => response.json())
    .then(countData => {
        total = countData.count || 0;
        const totalAvailable = countData.total_available || 0;
        if (totalAvailable > 50) {
            statusDiv.innerHTML = `Found ${totalAvailable} addresses, validating first ${total} to prevent timeout...`;
        } else {
            statusDiv.innerHTML = `Found ${total} addresses to validate...`;
        }
        
        // Start validation
        return fetch('/api/customers/validate_all_addresses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            btn.innerHTML = '<i class="fas fa-check"></i> Validation Complete';
            statusDiv.className = 'alert alert-success mt-2';
            let message = `Completed: ${data.validated} addresses validated, ${data.errors} errors`;
            if (data.note) {
                message += `<br><small>${data.note}</small>`;
            }
            statusDiv.innerHTML = message;
            setTimeout(() => {
                loadCustomerList();
                statusDiv.remove();
            }, 5000);
        } else {
            btn.innerHTML = originalText;
            statusDiv.className = 'alert alert-danger mt-2';
            statusDiv.innerHTML = 'Validation failed: ' + data.error;
            setTimeout(() => statusDiv.remove(), 5000);
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        statusDiv.className = 'alert alert-danger mt-2';
        statusDiv.innerHTML = 'Validation failed: ' + error.message;
        setTimeout(() => statusDiv.remove(), 5000);
    })
    .finally(() => {
        btn.disabled = false;
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 3000);
    });
}

function previewLicensePhoto(input) {
    const preview = document.getElementById('licensePreview');
    const img = document.getElementById('licensePreviewImg');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
    }
}

function previewEditLicensePhoto(input) {
    const preview = document.getElementById('editLicensePreview');
    const img = document.getElementById('editLicensePreviewImg');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
    }
}

// Load customer list on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCustomerList();
});
</script>
{% endblock %}