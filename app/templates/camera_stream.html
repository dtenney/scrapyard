{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5">Camera Stream</h1>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Live Camera Feed</h5>
            </div>
            <div class="card-body text-center">
                <canvas id="cameraStream" class="border" style="max-width: 100%; height: auto;"></canvas>
                <div class="mt-3">
                    <button class="btn btn-success" onclick="startStream()">
                        <i class="fas fa-play"></i> Start Stream
                    </button>
                    <button class="btn btn-warning" onclick="stopStream()">
                        <i class="fas fa-stop"></i> Stop Stream
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
import { pipelines } from 'https://cdn.jsdelivr.net/npm/media-stream-library@8/dist/esm/index.js';

let pipeline;
const canvas = document.getElementById('cameraStream');

window.startStream = function() {
    if (pipeline) {
        pipeline.close();
    }
    
    pipeline = new pipelines.Html5CanvasPipeline({
        ws: { uri: 'ws://10.0.10.39/rtsp-over-websocket/' },
        rtsp: { uri: 'rtsp://10.0.10.39/axis-media/media.amp?camera=1&resolution=640x480' },
        canvas: canvas
    });
    
    pipeline.ready.then(() => {
        pipeline.play();
    }).catch(err => {
        console.error('Stream error:', err);
        canvas.getContext('2d').fillText('Stream unavailable', 10, 30);
    });
};

window.stopStream = function() {
    if (pipeline) {
        pipeline.close();
        pipeline = null;
    }
};

// Auto-start stream
startStream();
</script>
{% endblock %}