{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5">Camera Stream</h1>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Live Camera Feed</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="tryMJPEG()">MJPEG</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="tryProxy()">Proxy</button>
                </div>
            </div>
            <div class="card-body text-center">
                <div id="streamContainer">
                    <img id="mjpegStream" class="border d-none" style="max-width: 100%; height: auto;">
                    <iframe id="proxyStream" class="border d-none" style="width: 100%; height: 480px;"></iframe>
                    <div id="statusMessage" class="alert alert-info">Initializing camera stream...</div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-success" onclick="refreshStream()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-info" onclick="testConnection()">
                        <i class="fas fa-network-wired"></i> Test Connection
                    </button>
                    <button class="btn btn-warning" onclick="debugCamera()">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                    <button class="btn btn-secondary" onclick="simpleTest()">
                        <i class="fas fa-wifi"></i> Simple Test
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentMethod = null;

function showStatus(message) {
    document.getElementById('statusMessage').textContent = message;
    document.getElementById('statusMessage').className = 'alert alert-info';
}

function showError(message) {
    document.getElementById('statusMessage').textContent = message;
    document.getElementById('statusMessage').className = 'alert alert-danger';
}

function hideAll() {
    document.getElementById('mjpegStream').classList.add('d-none');
    document.getElementById('proxyStream').classList.add('d-none');
}

function tryMJPEG() {
    hideAll();
    showStatus('Connecting to MJPEG stream...');
    
    const img = document.getElementById('mjpegStream');
    img.onload = function() {
        document.getElementById('statusMessage').classList.add('d-none');
        img.classList.remove('d-none');
        currentMethod = 'mjpeg';
    };
    img.onerror = function() {
        showError('MJPEG failed: Network error or CORS blocked - use Proxy method');
    };
    // Use Apache proxy instead of direct camera access
    img.src = '/camera/axis-cgi/mjpg/video.cgi?camera=1&resolution=640x480&' + Date.now();
}

function tryProxy() {
    hideAll();
    showStatus('Loading proxy stream...');
    
    const iframe = document.getElementById('proxyStream');
    iframe.onload = function() {
        document.getElementById('statusMessage').classList.add('d-none');
        iframe.classList.remove('d-none');
        currentMethod = 'proxy';
    };
    iframe.onerror = function() {
        showError('Proxy stream failed');
    };
    iframe.src = '/camera/axis-cgi/mjpg/video.cgi?resolution=640x480';
}

function refreshStream() {
    if (currentMethod === 'mjpeg') {
        tryMJPEG();
    } else if (currentMethod === 'proxy') {
        tryProxy();
    } else {
        tryMJPEG();
    }
}

function testConnection() {
    console.log('Test connection clicked');
    showStatus('Testing camera connection...');
    fetch('/api/camera/test')
    .then(response => {
        console.log('Test response:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Test data:', data);
        if (data.accessible) {
            showStatus('Camera accessible - Status: ' + data.status_code);
        } else {
            showError('Camera not accessible: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Test error:', err);
        showError('Test failed: ' + err.message);
    });
}

function debugCamera() {
    console.log('Debug camera clicked');
    showStatus('Running debug tests...');
    fetch('/api/camera/debug')
    .then(response => {
        console.log('Debug response:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Debug data:', data);
        showStatus('Debug results: ' + data.debug_results.join(' | '));
    })
    .catch(err => {
        console.error('Debug error:', err);
        showError('Debug failed: ' + err.message);
    });
}

function simpleTest() {
    console.log('Simple test clicked');
    showStatus('Testing basic camera connectivity...');
    fetch('/api/camera/simple')
    .then(response => response.json())
    .then(data => {
        if (data.camera_reachable) {
            showStatus('Camera reachable - Status: ' + data.status);
        } else {
            showError('Camera not reachable: ' + data.error);
        }
    })
    .catch(err => {
        showError('Simple test failed: ' + err.message);
    });
}

// Auto-start with MJPEG
tryMJPEG();
</script>
{% endblock %}